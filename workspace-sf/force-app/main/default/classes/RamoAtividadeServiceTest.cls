/**
 * Teste dos serviços do objeto RamoAtividade__c
 * @author Fernando Barcellos @ 05/12/2017
 *
 **/
@isTest
private class RamoAtividadeServiceTest {
	@testSetup
	static void setup() {
		Integracao__c integracao = new Integracao__c();
		integracao.Name = 'Ramos de Atividade';
		integracao.DeveloperName__c = 'RamoAtividade__c';
		integracao.UltimaExecucao__c = System.now();
		insert integracao;
	}

	@isTest
	static void testarSincronizacaoRamosAtividades() {
		// 28 registros conforme mock
//		String responseJsonString = '{"secoes":[{"secao":"A","denominacao":"AGRICULTURA, PECUÁRIA, PRODUÇÃO FLORESTAL, PESCA E AQÜICULTURA","divisoes":[{"divisao":"01","denominacao":"AGRICULTURA, PECUÁRIA E SERVIÇOS RELACIONADOS","grupos":[{"grupo":"01.1","denominacao":"Produção de lavouras temporárias","classes":[{"classe":"01.11-3","denominacao":"Cultivo de cereais","subclasses":[{"subclasse":"0111-3/01","denominacao":"Cultivo de arroz"}]}]},{"grupo":"01.2","denominacao":"Horticultura e floricultura","classes":[{"classe":"01.21-1","denominacao":"Horticultura","subclasses":[{"subclasse":"0121-1/01","denominacao":"Horticultura, exceto morango"},{"subclasse":"0121-1/02","denominacao":"Cultivo de morango"}]}]}]},{"divisao":"02","denominacao":"PRODUÇÃO FLORESTAL","grupos":[{"grupo":"02.1","denominacao":"Produção florestal - florestas plantadas","classes":[{"classe":"02.10-1","denominacao":"Produção florestal - florestas plantadas","subclasses":[{"subclasse":"0210-1/01","denominacao":"Cultivo de eucalipto"},{"subclasse":"0210-1/02","denominacao":"Cultivo de acácia-negra"},{"subclasse":"0210-1/03","denominacao":"Cultivo de pinus"},{"subclasse":"0210-1/99","denominacao":"Produção de produtos não-madeireiros não especificados anteriormente em florestas plantadas"}]}]}]}]},{"secao":"B","denominacao":"INDÚSTRIAS EXTRATIVAS","divisoes":[{"divisao":"05","denominacao":"EXTRAÇÃO DE CARVÃO MINERAL","grupos":[{"grupo":"05.0","denominacao":"Extração de carvão mineral","classes":[{"classe":"05.00-3","denominacao":"Extração de carvão mineral","subclasses":[{"subclasse":"0500-3/01","denominacao":"Extração de carvão mineral"},{"subclasse":"0500-3/02","denominacao":"Beneficiamento de carvão mineral"}]}]}]},{"divisao":"06","denominacao":"EXTRAÇÃO DE PETRÓLEO E GÁS NATURAL","grupos":[{"grupo":"06.0","denominacao":"Extração de petróleo e gás natural","classes":[{"classe":"06.00-0","denominacao":"Extração de petróleo e gás natural","subclasses":[{"subclasse":"0600-0/01","denominacao":"Extração de petróleo e gás natural"},{"subclasse":"0600-0/02","denominacao":"Extração e beneficiamento de xisto"},{"subclasse":"0600-0/03","denominacao":"Extração e beneficiamento de areias betuminosas"}]}]}]}]}]}';

		String responseJsonString = '{"ResponseObterDominiosCnae" : {"codigoRetorno" : 0,"cnae" : [ {"classe" : "0","divisao" : "0","grupo" : "0","nomeAtividadeCnae" : "Inválido","numeroCnae" : -3,"secao" : "#","subClasse" : "0"}, {"classe" : "0","divisao" : "0","grupo" : "0","nomeAtividadeCnae" : "Não informado","numeroCnae" : -2,"secao" : "$","subClasse" : "0"}, {"classe" : "0","divisao" : "0","grupo" : "0","nomeAtividadeCnae" : "Não se aplica","numeroCnae" : -1,"secao" : "@","subClasse" : "0"}, {"classe" : "0","divisao" : "0","grupo" : "0","nomeAtividadeCnae" : "AGRICULTURA, PECUARIA, PRODUCAO FLORESTAL, PESCA E AQUICULTURA","numeroCnae" : 1,"secao" : "A","subClasse" : "0"}, {"classe" : "0","divisao" : "1","grupo" : "0","nomeAtividadeCnae" : "AGRICULTURA, PECUARIA E SERVICOS RELACIONADOS","numeroCnae" : 2,"secao" : "A","subClasse" : "0"}, {"classe" : "0","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "PRODUCAO DE LAVOURAS TEMPORARIAS","numeroCnae" : 3,"secao" : "A","subClasse" : "0"}, {"classe" : "13","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE CEREAIS","numeroCnae" : 4,"secao" : "A","subClasse" : "0"}, {"classe" : "13","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE ARROZ","numeroCnae" : 5,"secao" : "A","subClasse" : "1"}, {"classe" : "13","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE MILHO","numeroCnae" : 6,"secao" : "A","subClasse" : "2"}, {"classe" : "13","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE TRIGO","numeroCnae" : 7,"secao" : "A","subClasse" : "3"}, {"classe" : "13","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE OUTROS CEREAIS NAO ESPECIFICADOS ANTERIORMENTE","numeroCnae" : 8,"secao" : "A","subClasse" : "99"}, {"classe" : "21","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE ALGODAO HERBACEO E DE OUTRAS FIBRAS DE LAVOURA TEMPORARIA","numeroCnae" : 9,"secao" : "A","subClasse" : "0"}, {"classe" : "21","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE ALGODAO HERBACEO","numeroCnae" : 10,"secao" : "A","subClasse" : "1"}, {"classe" : "21","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE JUTA","numeroCnae" : 11,"secao" : "A","subClasse" : "2"}, {"classe" : "21","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE OUTRAS FIBRAS DE LAVOURA TEMPORARIA NAO ESPECIFICADAS ANTERIORMENTE","numeroCnae" : 12,"secao" : "A","subClasse" : "99"}, {"classe" : "30","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE CANA-DE-ACUCAR","numeroCnae" : 13,"secao" : "A","subClasse" : "0"}, {"classe" : "30","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE CANA-DE-ACUCAR","numeroCnae" : 14,"secao" : "A","subClasse" : "0"}, {"classe" : "48","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE FUMO","numeroCnae" : 15,"secao" : "A","subClasse" : "0"}, {"classe" : "48","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE FUMO","numeroCnae" : 16,"secao" : "A","subClasse" : "0"}, {"classe" : "56","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE SOJA","numeroCnae" : 17,"secao" : "A","subClasse" : "0"}, {"classe" : "56","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE SOJA","numeroCnae" : 18,"secao" : "A","subClasse" : "0"}, {"classe" : "64","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE OLEAGINOSAS DE LAVOURA TEMPORARIA, EXCETO SOJA","numeroCnae" : 19,"secao" : "A","subClasse" : "0"}, {"classe" : "64","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE AMENDOIM","numeroCnae" : 20,"secao" : "A","subClasse" : "1"}, {"classe" : "64","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE GIRASSOL","numeroCnae" : 21,"secao" : "A","subClasse" : "2"}, {"classe" : "64","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE MAMONA","numeroCnae" : 22,"secao" : "A","subClasse" : "3"}, {"classe" : "64","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE OUTRAS OLEAGINOSAS DE LAVOURA TEMPORARIA NAO ESPECIFICADAS ANTERIORMENTE","numeroCnae" : 23,"secao" : "A","subClasse" : "99"}, {"classe" : "99","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE PLANTAS DE LAVOURA TEMPORARIA NAO ESPECIFICADAS ANTERIORMENTE","numeroCnae" : 24,"secao" : "A","subClasse" : "0"}, {"classe" : "99","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE ABACAXI","numeroCnae" : 25,"secao" : "A","subClasse" : "1"}]}}';

		Test.setMock(HttpCalloutMock.class, new MockHttpResponse(responseJsonString, 200, 'OK'));
		Test.startTest();

		IntegracaoBO.getInstance().executarIntegracao(RamoAtividade__c.sObjectType.getDescribe().getName());

		String nomeObjeto = RamoAtividade__c.sObjectType.getDescribe().getName();
		Integracao__c integracao = [SELECT Id, Name, UltimaExecucao__c FROM Integracao__c WHERE DeveloperName__c =: nomeObjeto LIMIT 1];

		Test.stopTest();

		System.assert(integracao != null);
		System.assert(integracao.UltimaExecucao__c <= System.now());
		List<RamoAtividade__c> dados = [SELECT Id, Name, CodigoSubclasse__c, Status__c FROM RamoAtividade__c WHERE Status__c = 'Em análise'];
		System.debug(JSON.serializePretty(dados));
		System.assertEquals(true, dados.size() > 0);
	}

	@isTest
	static void testarErroSincronizacao() {
		// 28 registros conforme mock
//		String responseJsonString = '{"secoes":[{"secao":"A","denominacao":"AGRICULTURA, PECUÁRIA, PRODUÇÃO FLORESTAL, PESCA E AQÜICULTURA","divisoes":[{"divisao":"01","denominacao":"AGRICULTURA, PECUÁRIA E SERVIÇOS RELACIONADOS","grupos":[{"grupo":"01.1","denominacao":"Produção de lavouras temporárias","classes":[{"classe":"01.11-3","denominacao":"Cultivo de cereais","subclasses":[{"subclasse":"0111-3/01","denominacao":"Cultivo de arroz"}]}]},{"grupo":"01.2","denominacao":"Horticultura e floricultura","classes":[{"classe":"01.21-1","denominacao":"Horticultura","subclasses":[{"subclasse":"0121-1/01","denominacao":"Horticultura, exceto morango"},{"subclasse":"0121-1/02","denominacao":"Cultivo de morango"}]}]}]},{"divisao":"02","denominacao":"PRODUÇÃO FLORESTAL","grupos":[{"grupo":"02.1","denominacao":"Produção florestal - florestas plantadas","classes":[{"classe":"02.10-1","denominacao":"Produção florestal - florestas plantadas","subclasses":[{"subclasse":"0210-1/01","denominacao":"Cultivo de eucalipto"},{"subclasse":"0210-1/02","denominacao":"Cultivo de acácia-negra"},{"subclasse":"0210-1/03","denominacao":"Cultivo de pinus"},{"subclasse":"0210-1/99","denominacao":"Produção de produtos não-madeireiros não especificados anteriormente em florestas plantadas"}]}]}]}]},{"secao":"B","denominacao":"INDÚSTRIAS EXTRATIVAS","divisoes":[{"divisao":"05","denominacao":"EXTRAÇÃO DE CARVÃO MINERAL","grupos":[{"grupo":"05.0","denominacao":"Extração de carvão mineral","classes":[{"classe":"05.00-3","denominacao":"Extração de carvão mineral","subclasses":[{"subclasse":"0500-3/01","denominacao":"Extração de carvão mineral"},{"subclasse":"0500-3/02","denominacao":"Beneficiamento de carvão mineral"}]}]}]},{"divisao":"06","denominacao":"EXTRAÇÃO DE PETRÓLEO E GÁS NATURAL","grupos":[{"grupo":"06.0","denominacao":"Extração de petróleo e gás natural","classes":[{"classe":"06.00-0","denominacao":"Extração de petróleo e gás natural","subclasses":[{"subclasse":"0600-0/01","denominacao":"Extração de petróleo e gás natural"},{"subclasse":"0600-0/02","denominacao":"Extração e beneficiamento de xisto"},{"subclasse":"0600-0/03","denominacao":"Extração e beneficiamento de areias betuminosas"}]}]}]}]}]}';

		String responseJsonString = '{"ResponseObterDominiosCnae" : {"codigoRetorno" : 0,"cnae" : [ {"classe" : "0","divisao" : "0","grupo" : "0","nomeAtividadeCnae" : "Inválido","numeroCnae" : -3,"secao" : "#","subClasse" : "0"}, {"classe" : "0","divisao" : "0","grupo" : "0","nomeAtividadeCnae" : "Não informado","numeroCnae" : -2,"secao" : "$","subClasse" : "0"}, {"classe" : "0","divisao" : "0","grupo" : "0","nomeAtividadeCnae" : "Não se aplica","numeroCnae" : -1,"secao" : "@","subClasse" : "0"}, {"classe" : "0","divisao" : "0","grupo" : "0","nomeAtividadeCnae" : "AGRICULTURA, PECUARIA, PRODUCAO FLORESTAL, PESCA E AQUICULTURA","numeroCnae" : 1,"secao" : "A","subClasse" : "0"}, {"classe" : "0","divisao" : "1","grupo" : "0","nomeAtividadeCnae" : "AGRICULTURA, PECUARIA E SERVICOS RELACIONADOS","numeroCnae" : 2,"secao" : "A","subClasse" : "0"}, {"classe" : "0","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "PRODUCAO DE LAVOURAS TEMPORARIAS","numeroCnae" : 3,"secao" : "A","subClasse" : "0"}, {"classe" : "13","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE CEREAIS","numeroCnae" : 4,"secao" : "A","subClasse" : "0"}, {"classe" : "13","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE ARROZ","numeroCnae" : 5,"secao" : "A","subClasse" : "1"}, {"classe" : "13","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE MILHO","numeroCnae" : 6,"secao" : "A","subClasse" : "2"}, {"classe" : "13","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE TRIGO","numeroCnae" : 7,"secao" : "A","subClasse" : "3"}, {"classe" : "13","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE OUTROS CEREAIS NAO ESPECIFICADOS ANTERIORMENTE","numeroCnae" : 8,"secao" : "A","subClasse" : "99"}, {"classe" : "21","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE ALGODAO HERBACEO E DE OUTRAS FIBRAS DE LAVOURA TEMPORARIA","numeroCnae" : 9,"secao" : "A","subClasse" : "0"}, {"classe" : "21","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE ALGODAO HERBACEO","numeroCnae" : 10,"secao" : "A","subClasse" : "1"}, {"classe" : "21","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE JUTA","numeroCnae" : 11,"secao" : "A","subClasse" : "2"}, {"classe" : "21","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE OUTRAS FIBRAS DE LAVOURA TEMPORARIA NAO ESPECIFICADAS ANTERIORMENTE","numeroCnae" : 12,"secao" : "A","subClasse" : "99"}, {"classe" : "30","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE CANA-DE-ACUCAR","numeroCnae" : 13,"secao" : "A","subClasse" : "0"}, {"classe" : "30","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE CANA-DE-ACUCAR","numeroCnae" : 14,"secao" : "A","subClasse" : "0"}, {"classe" : "48","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE FUMO","numeroCnae" : 15,"secao" : "A","subClasse" : "0"}, {"classe" : "48","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE FUMO","numeroCnae" : 16,"secao" : "A","subClasse" : "0"}, {"classe" : "56","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE SOJA","numeroCnae" : 17,"secao" : "A","subClasse" : "0"}, {"classe" : "56","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE SOJA","numeroCnae" : 18,"secao" : "A","subClasse" : "0"}, {"classe" : "64","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE OLEAGINOSAS DE LAVOURA TEMPORARIA, EXCETO SOJA","numeroCnae" : 19,"secao" : "A","subClasse" : "0"}, {"classe" : "64","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE AMENDOIM","numeroCnae" : 20,"secao" : "A","subClasse" : "1"}, {"classe" : "64","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE GIRASSOL","numeroCnae" : 21,"secao" : "A","subClasse" : "2"}, {"classe" : "64","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE MAMONA","numeroCnae" : 22,"secao" : "A","subClasse" : "3"}, {"classe" : "64","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE OUTRAS OLEAGINOSAS DE LAVOURA TEMPORARIA NAO ESPECIFICADAS ANTERIORMENTE","numeroCnae" : 23,"secao" : "A","subClasse" : "99"}, {"classe" : "99","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE PLANTAS DE LAVOURA TEMPORARIA NAO ESPECIFICADAS ANTERIORMENTE","numeroCnae" : 24,"secao" : "A","subClasse" : "0"}, {"classe" : "99","divisao" : "1","grupo" : "1","nomeAtividadeCnae" : "CULTIVO DE ABACAXI","numeroCnae" : 25,"secao" : "A","subClasse" : "1"}]}}';

		Test.setMock(HttpCalloutMock.class, new MockHttpResponse(responseJsonString, 500, 'OK'));
		Test.startTest();

		try {
			IntegracaoBO.getInstance().executarIntegracao(RamoAtividade__c.sObjectType.getDescribe().getName());
		}
		catch(Exception e) {
			System.assertEquals('Erro ao buscar ramos de atividade.', e.getMessage());
		}

		String nomeObjeto = RamoAtividade__c.sObjectType.getDescribe().getName();
		Integracao__c integracao = [SELECT Id, Name, UltimaExecucao__c FROM Integracao__c WHERE DeveloperName__c =: nomeObjeto LIMIT 1];

		Test.stopTest();
	}
}