/*
@description  Realiza o envio do email de renovação para o corretor
@author Rogerio Menezes - Globant
@date 21/07/2022
@Classe criada por conta da história RVI-57
*/

public with sharing class EnviaEmailCorretor {

    public class FlowInputs {
        @InvocableVariable public String contratoId;
        @InvocableVariable public String numeroApolice;
        @InvocableVariable public String vigenciaFinal;
        @InvocableVariable public String email;
        @InvocableVariable public String nome;
        @InvocableVariable public String proposta;
        @InvocableVariable public String linkApolice;
    }

    @invocableMethod
    public static void formatEmailPagCartao(List<FlowInputs> requestId){

        List<ImagemTemplate__mdt> urlTempalte = [SELECT UrlImagem__c FROM ImagemTemplate__mdt WHERE NomeTemplate__c = 'Header Renovacao']; //RVI-194 - INICIO/FIM
        List<ImagemTemplate__mdt> urlTemplatePagamento = [SELECT UrlImagem__c FROM ImagemTemplate__mdt WHERE NomeTemplate__c = 'Header Renovacao Pagamento']; // RVI-186 - INICIO/FIM

        System.debug('Valor do Id: ' + requestId[0].contratoId);
        List<FavorecidoRemuneracaoContrato__c> favorecido = [SELECT Conta__r.Email__c  
                                                       FROM FavorecidoRemuneracaoContrato__c 
                                                       WHERE RemuneracaoContrato__r.Contrato__c =: requestId[0].contratoId];
        List<GarantiaContrato__c> cliente = [SELECT Capital__c, Garantia__r.Name, 
                                                       Contrato__r.Proposta__r.CodigoCorretor__r.Name, Contrato__r.AlteraFormaPagto__c, Contrato__r.ContratoRenovado__c,  //RVI-186-FIX02 - INICIO/FIM
                                                       Contrato__r.Proposta__r.Account.Name,
                                                       Contrato__r.Proposta__r.FormaPagamento__r.Name
                                                       FROM GarantiaContrato__c WHERE Contrato__c =: requestId[0].contratoId];

        // RVI-186-FIX02 - INICIO
        List<Contract> contratoAltPg = [ SELECT Id, AlteraFormaPagto__c FROM Contract WHERE Id =: cliente[0].Contrato__r.ContratoRenovado__c ];
        // RVI-186-FIX02 - FIM

        if(favorecido.size() > 0){
            // RVI-186 - INICIO
            if(contratoAltPg[0].AlteraFormaPagto__c){  // RVI-186 - FIX02 - INICIO/FIM 
                String bodyToSend = '<html><head><title></title></head><body><table align="center" bgcolor="#ffffff" border="0" cellpadding="0" cellspacing="0" class="principal" width="600"><tbody><tr><td><img src="#ImagemEmail#" style="display: block; max-width: 100%; width: 600px; height: 354px;" /></td></tr><tr><td style="padding:30px;"><table border="0" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="padding-bottom: 10px"><p style="font-size:20px; line-height:20px;color: #0099ff;"><span style="font-size:20px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>Ol&aacute; #nome#,</strong></span></span></p><p style="text-align: justify;"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Estamos felizes em ter voc&ecirc; como cliente e agradecemos a confian&ccedil;a com a nossa marca. &Eacute; um honra sermos esse Porto Seguro para voc&ecirc; e a sua fam&iacute;lia.</span></span></p><p style="text-align: justify;"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Chegou o momento de informar que a renova&ccedil;&atilde;o do seu seguro foi conclu&iacute;da na forma de pagamento em boleto banc&aacute;rio, uma vez que pelo cart&atilde;o de cr&eacute;dito n&atilde;o foi poss&iacute;vel prosseguir.</span></span></p><p style="text-align: justify;"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Mas n&atilde;o se preocupe porque agora voc&ecirc; vai poder continuar com a prote&ccedil;&atilde;o necess&aacute;ria para diferentes momentos da sua vida.</span></span></span></p><p style="text-align: justify;"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Afinal, ter uma garantia financeira em casos de imprevistos &eacute; a melhor forma de preservar o seu bem estar financeiro e o da sua fam&iacute;lia, conforme ap&oacute;lice que voc&ecirc; pode conferir na <a href="http://www.portoseguro.com.br/cliente">&Aacute;rea do Cliente.</a></span></p><p style="text-align: justify;"><strong><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">A seguir voc&ecirc; confere o valor de capital segurado e as prote&ccedil;&otilde;es do seu seguro de vida:</span></span></strong></p><table border="0" cellpadding="1" cellspacing="1" style="width: 530px"><tbody><tr><td style="text-align: center; background-color: rgb(214, 215, 210);"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Cobertura</span></span></td><td style="text-align: center; background-color: rgb(214, 215, 210);"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Capital Segurado</span></span></td></tr><tr><td style="text-align: center;"><span style="font-size:14px;">#garantiaNome#</span></td><td style="text-align: center;"><span style="font-size:14px;">#garantiaCapital#</span></td></tr></tbody></table></td></tr><tr><td style="padding-bottom: 10px"><p style="text-align: justify;"><br /><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Lembramos que, de acordo com as condi&ccedil;&otilde;es contratuais, o valor mensal do seu seguro e os capitais segurados est&atilde;o sendo reajustados. </span></span></p><p style="text-align: justify;"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Em caso de d&uacute;vida, acesse&nbsp;<a href="http://www.portoseguro.com.br/vida" target="_blank">www.portoseguro.com.br/vida</a>&nbsp;e confira a Condi&ccedil;&atilde;o Geral, no item &quot;Reajuste do Pr&ecirc;mio por Idade e Atualiza&ccedil;&atilde;o do Capital&quot;.</span></span></p> <p style="text-align: justify;"></td></tr></tbody></table></td></tr><tr><td bgcolor="#f7f7f7" style="padding: 30px;"><table cellpadding="0" cellspacing="0" class="columns" style="float:left;" width="25%"><tbody><tr><td class="mobile"><img alt="" src="https://www.portoseguro.com.br/NovoInstitucional/static_files/images/Informes%20de%20Rendimentos/Imagens/Vida%20Inteira/portoseguro-icon2png.png" style="width: 104px; height: 72px;" /></td></tr></tbody></table><table cellpadding="0" cellspacing="0" class="columns" style="float:left;" width="75%"><tbody><tr><td style="font-size: 14px;"><p style="text-align: justify;"><strong style="font-family: arial, helvetica, sans-serif; font-size: 16px;">Confira abaixo os dados do seu cadastro:</strong><br /><br /><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>Proposta n&ordm;:</strong>#proposta#<br /><strong>Ap&oacute;lice n&deg;:&nbsp;</strong></span></span><span style="font-family: arial, helvetica, sans-serif;">#apolice#</span><br /><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>Vig&ecirc;ncia:&nbsp;</strong></span></span><span style="font-family: arial, helvetica, sans-serif;">#vigenciaFinal#</span><br /><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>Corretor:&nbsp;</strong>#corretor#</span></span></p> </td></tr></tbody></table></td></tr><tr><td bgcolor="#f7f7f7" style="padding: 30px;"><table cellpadding="0" cellspacing="0" class="columns" style="float: left;" width="25%"><tbody><tr><td class="mobile"><img alt="" src="https://www.portoseguro.com.br/NovoInstitucional/static_files/images/Informes%20de%20Rendimentos/Imagens/Vida%20Inteira/portoseguro-icon3png.png" style="width: 104px; height: 72px;" /></td></tr></tbody></table><table cellpadding="0" cellspacing="0" class="columns" style="float: left;" width="75%"><tbody><tr><td style="font-size: 14px;"><p style="text-align: justify;"><span style="font-family: arial, helvetica, sans-serif;">Continuamos &agrave; sua disposi&ccedil;&atilde;o e, sempre que precisar, n&atilde;o deixe de falar com o seu Corretor ou entrar em contato conosco pelos canais digitais como&nbsp;<strong>WhatsApp</strong>, atrav&eacute;s do n&uacute;mero&nbsp;<strong>(11) 3003-9303</strong>,&nbsp;<a href="http://www.portoseguro.com.br/a-porto-seguro/fale-com-a-porto-seguro/chat-on-line">Chat Online.</a>&nbsp;Estamos dispon&iacute;veis tamb&eacute;m na&nbsp;<strong>Central de Atendimento</strong>, nos telefones&nbsp;<strong>(11) 3366-3377</strong>&nbsp;(Capital e Grande S&atilde;o Paulo) e&nbsp;<strong>0800 727 9393</strong>&nbsp;(Demais localidades).</span></p></td></tr></tbody></table></td></tr><tr><td style="padding: 30px; line-height: 24px"><table border="0" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="padding-bottom: 20px; border-bottom: 1px solid #929292;"><span style="font-family:arial,helvetica,sans-serif;"><span style="font-size: 14px;">Um abra&ccedil;o!</span><br /><br /><span style="font-size: 20px;">Porto Seguro <strong style="color: #3c97a8;">Para Toda Vida</strong>.</span></span></td></tr></tbody></table></td></tr><tr><td style="padding: 30px; line-height: 24px; text-align: justify;"><p><span style="font-size:10px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>11 3366 3377</strong>&nbsp;(Grande S&atilde;o Paulo) |&nbsp;<strong>0800 727 9393</strong>&nbsp;(Demais localidades) |&nbsp;<strong>0800 727 2746</strong>&nbsp;(SAC - informa&ccedil;&atilde;o, reclama&ccedil;&atilde;o e cancelamento - 24horas) |&nbsp;<strong>0800 727 8736</strong>&nbsp;(SAC 24h - atendimento exclusivo para deficientes auditivos) |&nbsp;<strong>0800 727 1184</strong>&nbsp;(Ouvidoria - das 8h15 &agrave;s 18h30, de segunda a sexta-feira, exceto feriados)</span></span></p><p><span style="font-size:10px;"><span style="font-family:arial,helvetica,sans-serif;">Informa&ccedil;&otilde;es reduzidas. Consulte as Condi&ccedil;&otilde;es Gerais do seguro contratado no site&nbsp;<a href="https://www.google.com/url?q=http://www.portoseguro.com.br/vida?utm_campaign%3Dcomm_news_vida%26utm_source%3Drodape_fixo%26utm_medium%3Deml&amp;source=gmail-html&amp;ust=1638471085772000&amp;usg=AOvVaw0vPwZ0fQ39QESNo6m5z8dZ" target="_blank">www.portoseguro.com.br/vida</a>. Processos Susep: Seguro de Pessoais Individual: 15414.901355/2016-07. Antes de contratar consulte as condi&ccedil;&otilde;es gerais. O registro deste plano na SUSEP n&atilde;o implica, por parte da Autarquia, incentivo ou recomenda&ccedil;&atilde;o &agrave; sua comercializa&ccedil;&atilde;o. A aceita&ccedil;&atilde;o do seguro est&aacute; sujeita &agrave; an&aacute;lise de risco.</span></span></p><p><span style="font-size:10px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>Porto Seguro Cia de Seguros Gerais</strong><br />Al. Bar&atilde;o de Piracicaba, 618 - Torre B - 3&ordm; Andar - Campos El&iacute;seos - S&atilde;o Paulo - SP - CEP 01216-012</span></span></p></td></tr></tbody></table><p>&nbsp;</p></body></html>';  

                String capital = '';
                String nomeGarantias = '';
                for(integer i=0; i < cliente.size(); i++){
                    capital += String.valueOf(cliente[i].Capital__c) + '<br>';
                    nomeGarantias += cliente[i].Garantia__r.Name + '<br>';
                }
                
                bodyToSend = bodyToSend.replace('#ImagemEmail#', urlTemplatePagamento[0].UrlImagem__c);
                bodyToSend = bodyToSend.replace('#garantiaNome#', nomeGarantias);
                bodyToSend = bodyToSend.replace('#garantiaCapital#', capital);
                bodyToSend = bodyToSend.replace('#linkApolice#', requestId[0].linkApolice);
                bodyToSend = bodyToSend.replace('#nome#', cliente[0].Contrato__r.Proposta__r.Account.Name);
                bodyToSend = bodyToSend.replace('#apolice#', requestId[0].numeroApolice);
                bodyToSend = bodyToSend.replace('#proposta#', requestId[0].proposta);
                bodyToSend = bodyToSend.replace('#vigenciaFinal#', requestId[0].vigenciaFinal);
                bodyToSend = bodyToSend.replace('#corretor#', cliente[0].Contrato__r.Proposta__r.CodigoCorretor__r.Name);

                if(cliente[0].Contrato__r.Proposta__r.FormaPagamento__r.Name == 'FRAC.1.A PARCELA CARNE' && favorecido[0].Conta__r.Email__c != null && requestId[0].linkApolice != null && requestId[0].linkApolice != ''){
                    Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
                    String[] toAddresses = new String[] {favorecido[0].Conta__r.Email__c};
                    email.setToAddresses(toAddresses);
                    email.setSubject('Forma de Pagamento alterada');
                    email.setHtmlBody(bodyToSend);
            
                    Messaging.SendEmailResult[] results = Messaging.sendEmail(new Messaging.SingleEmailMessage[] { email });
                    System.debug('Rogerio email' + results);
                } 
                
            }else{
                String bodyToSend = '<html><head><title></title></head><body><table align="center" bgcolor="#ffffff" border="0" cellpadding="0" cellspacing="0" class="principal" width="600"><tbody><tr><td><img src="#ImagemEmail#" style="display: block; max-width: 100%; width: 600px; height: 354px;" /></td></tr><tr><td style="padding:30px;"><table border="0" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="padding-bottom: 10px"><p style="font-size:20px; line-height:20px;color: #0099ff;"><span style="font-size:20px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>Ol&aacute; #nome#,</strong></span></span></p><p style="text-align: justify;"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Estamos felizes em ter voc&ecirc; como cliente e agradecemos a confian&ccedil;a de escolher ser cada vez mais um Porto Seguro para voc&ecirc; e sua fam&iacute;lia.</span></span></p><p style="text-align: justify;"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Chegou o momento de renovar o seu seguro de vida e garantir a seguran&ccedil;a necess&aacute;ria com uma prote&ccedil;&atilde;o que mantem mais tranquilidade para todos os momentos da vida.</span></span></p><p style="text-align: justify;"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Dessa forma, basta realizar o pagamento da primeira parcela, conforme a op&ccedil;&atilde;o escolhida <!--RVI-210 INICIO --> <!-- no documento anexo--> em sua contratação. <!-- RVI-210 FIM --></span></span></p><p style="text-align: justify;"><strong><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">A seguir voc&ecirc; confere o valor de capital segurado e as prote&ccedil;&otilde;es do seu seguro de vida:</span></span></strong></p><table border="0" cellpadding="1" cellspacing="1" style="width: 530px"><tbody><tr><td style="text-align: center; background-color: rgb(214, 215, 210);"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Cobertura</span></span></td><td style="text-align: center; background-color: rgb(214, 215, 210);"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Capital Segurado</span></span></td></tr><tr><td style="text-align: center;"><span style="font-size:14px;">#garantiaNome#</span></td><td style="text-align: center;"><span style="font-size:14px;">#garantiaCapital#</span></td></tr></tbody></table></td></tr><tr><td style="padding-bottom: 10px"><p style="text-align: justify;"><br /><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Lembramos que, de acordo com as condi&ccedil;&otilde;es contratuais, o valor mensal do seu seguro est&aacute; sendo reajustado. </span></span></p><p style="text-align: justify;"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;">Em caso de d&uacute;vida, acesse&nbsp;<a href="http://www.portoseguro.com.br/vida" target="_blank">www.portoseguro.com.br/vida</a>&nbsp;e confira a Condi&ccedil;&atilde;o Geral, no item &quot;Reajuste do Pr&ecirc;mio por Idade e Atualiza&ccedil;&atilde;o do Capital&quot;.</span></span></p> <p style="text-align: justify;"><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;"><!--RVI-210 INICIO --><!--<a href="#linkApolice#">Clique aqui</a> e confira a apólice do seu Seguro de Vida Individual, com as especificações de seguro e das coberturas contratadas.--><!--RVI-210 FIM --></span></span></p></td></tr></tbody></table></td></tr><tr><td bgcolor="#f7f7f7" style="padding: 30px;"><table cellpadding="0" cellspacing="0" class="columns" style="float:left;" width="25%"><tbody><tr><td class="mobile"><img alt="" src="https://www.portoseguro.com.br/NovoInstitucional/static_files/images/Informes%20de%20Rendimentos/Imagens/Vida%20Inteira/portoseguro-icon2png.png" style="width: 104px; height: 72px;" /></td></tr></tbody></table><table cellpadding="0" cellspacing="0" class="columns" style="float:left;" width="75%"><tbody><tr><td style="font-size: 14px;"><p style="text-align: justify;"><strong style="font-family: arial, helvetica, sans-serif; font-size: 16px;">Confira abaixo os dados do seu cadastro:</strong><br /><br /><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>Proposta n&ordm;:</strong>#proposta#<br /><strong>Ap&oacute;lice n&deg;:&nbsp;</strong></span></span><span style="font-family: arial, helvetica, sans-serif;">#apolice#</span><br /><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>Vig&ecirc;ncia:&nbsp;</strong></span></span><span style="font-family: arial, helvetica, sans-serif;">#vigenciaFinal#</span><br /><span style="font-size:14px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>Corretor:&nbsp;</strong>#corretor#</span></span></p> </td></tr></tbody></table></td></tr><tr><td bgcolor="#f7f7f7" style="padding: 30px;"><table cellpadding="0" cellspacing="0" class="columns" style="float: left;" width="25%"><tbody><tr><td class="mobile"><img alt="" src="https://www.portoseguro.com.br/NovoInstitucional/static_files/images/Informes%20de%20Rendimentos/Imagens/Vida%20Inteira/portoseguro-icon3png.png" style="width: 104px; height: 72px;" /></td></tr></tbody></table><table cellpadding="0" cellspacing="0" class="columns" style="float: left;" width="75%"><tbody><tr><td style="font-size: 14px;"><p style="text-align: justify;"><span style="font-family: arial, helvetica, sans-serif;">Continuamos &agrave; sua disposi&ccedil;&atilde;o e, sempre que precisar, n&atilde;o deixe de falar com o seu Corretor ou entrar em contato conosco pelos canais digitais como&nbsp;<strong>WhatsApp</strong>, atrav&eacute;s do n&uacute;mero&nbsp;<strong>(11) 3003-9303</strong>,&nbsp;<a href="http://www.portoseguro.com.br/a-porto-seguro/fale-com-a-porto-seguro/chat-on-line">Chat Online</a>&nbsp;ou&nbsp;<a href="http://www.portoseguro.com.br/cliente">&Aacute;rea do Cliente</a>. Estamos dispon&iacute;veis tamb&eacute;m na&nbsp;<strong>Central de Atendimento</strong>, nos telefones&nbsp;<strong>(11) 3366-3377</strong>&nbsp;(Capital e Grande S&atilde;o Paulo) e&nbsp;<strong>0800 727 9393</strong>&nbsp;(Demais localidades).</span></p></td></tr></tbody></table></td></tr><tr><td style="padding: 30px; line-height: 24px"><table border="0" cellpadding="0" cellspacing="0" width="100%"><tbody><tr><td style="padding-bottom: 20px; border-bottom: 1px solid #929292;"><span style="font-family:arial,helvetica,sans-serif;"><span style="font-size: 14px;">Um abra&ccedil;o!</span><br /><br /><span style="font-size: 20px;">Porto Seguro <strong style="color: #3c97a8;">Para Toda Vida</strong>.</span></span></td></tr></tbody></table></td></tr><tr><td style="padding: 30px; line-height: 24px; text-align: justify;"><p><span style="font-size:10px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>11 3366 3377</strong>&nbsp;(Grande S&atilde;o Paulo) |&nbsp;<strong>0800 727 9393</strong>&nbsp;(Demais localidades) |&nbsp;<strong>0800 727 2746</strong>&nbsp;(SAC - informa&ccedil;&atilde;o, reclama&ccedil;&atilde;o e cancelamento - 24horas) |&nbsp;<strong>0800 727 8736</strong>&nbsp;(SAC 24h - atendimento exclusivo para deficientes auditivos) |&nbsp;<strong>0800 727 1184</strong>&nbsp;(Ouvidoria - das 8h15 &agrave;s 18h30, de segunda a sexta-feira, exceto feriados)</span></span></p><p><span style="font-size:10px;"><span style="font-family:arial,helvetica,sans-serif;">Informa&ccedil;&otilde;es reduzidas. Consulte as Condi&ccedil;&otilde;es Gerais do seguro contratado no site&nbsp;<a href="https://www.google.com/url?q=http://www.portoseguro.com.br/vida?utm_campaign%3Dcomm_news_vida%26utm_source%3Drodape_fixo%26utm_medium%3Deml&amp;source=gmail-html&amp;ust=1638471085772000&amp;usg=AOvVaw0vPwZ0fQ39QESNo6m5z8dZ" target="_blank">www.portoseguro.com.br/vida</a>. Processos Susep: Seguro de Pessoais Individual: 15414.901355/2016-07. Antes de contratar consulte as condi&ccedil;&otilde;es gerais. O registro deste plano na SUSEP n&atilde;o implica, por parte da Autarquia, incentivo ou recomenda&ccedil;&atilde;o &agrave; sua comercializa&ccedil;&atilde;o. A aceita&ccedil;&atilde;o do seguro est&aacute; sujeita &agrave; an&aacute;lise de risco.</span></span></p><p><span style="font-size:10px;"><span style="font-family:arial,helvetica,sans-serif;"><strong>Porto Seguro Cia de Seguros Gerais</strong><br /> 							Al. Bar&atilde;o de Piracicaba, 618 - Torre B - 3&ordm; Andar - Campos El&iacute;seos - S&atilde;o Paulo - SP - CEP 01216-012</span></span></p> 					</td> 				</tr></tbody></table><p> 			&nbsp;</p> </body></html>'; //RVI-194 - INICIO/FIM

                String capital = '';
                String nomeGarantias = '';
                for(integer i=0; i < cliente.size(); i++){
                    capital += String.valueOf(cliente[i].Capital__c) + '<br>';
                    nomeGarantias += cliente[i].Garantia__r.Name + '<br>';
                }

                bodyToSend = bodyToSend.replace('#ImagemEmail#', urlTempalte[0].UrlImagem__c); //RVI-194 - INICIO/FIM
                bodyToSend = bodyToSend.replace('#garantiaNome#', nomeGarantias);
                bodyToSend = bodyToSend.replace('#garantiaCapital#', capital);
                bodyToSend = bodyToSend.replace('#linkApolice#', requestId[0].linkApolice);
                bodyToSend = bodyToSend.replace('#nome#', cliente[0].Contrato__r.Proposta__r.Account.Name);
                bodyToSend = bodyToSend.replace('#apolice#', requestId[0].numeroApolice);
                bodyToSend = bodyToSend.replace('#proposta#', requestId[0].proposta);
                bodyToSend = bodyToSend.replace('#vigenciaFinal#', requestId[0].vigenciaFinal);
                bodyToSend = bodyToSend.replace('#corretor#', cliente[0].Contrato__r.Proposta__r.CodigoCorretor__r.Name);
                
                if(cliente[0].Contrato__r.Proposta__r.FormaPagamento__r.Name != 'FRAC.1.A PARCELA CARNE' && favorecido[0].Conta__r.Email__c != null && requestId[0].linkApolice != null && requestId[0].linkApolice != ''){                
                    Messaging.SingleEmailMessage email = new Messaging.SingleEmailMessage();
                    String[] toAddresses = new String[] {favorecido[0].Conta__r.Email__c};
                    email.setToAddresses(toAddresses);
                    email.setSubject('Renovação');
                    email.setHtmlBody(bodyToSend);
                Messaging.SendEmailResult[] results = Messaging.sendEmail(new Messaging.SingleEmailMessage[] { email });
                System.debug('Rogerio email' + results);
                }
            System.debug('favorecido não encontrado');
            }
            // RVI-186 -FIM
        }    
    }
}